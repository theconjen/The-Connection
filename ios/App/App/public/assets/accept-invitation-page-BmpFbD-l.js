import{r as e,j as s}from"./vendor-radix-Cb0-vzxO.js";import{v as i,n as t,u as a,h as n,C as r,b as c,f as m,j as d,a as l,B as o,q as x,i as u}from"./index-CQmKbNyS.js";import{u as h,a as j}from"./vendor-query-qkAKzVJ0.js";import{A as p,b as v,c as g,d as y,e as N,h as b}from"./alert-dialog-CyKD1gnU.js";import{q as f,am as w,i as C,s as I,a8 as A,U as T,a4 as k,r as q,ac as E}from"./vendor-icons-CM8Yk8yJ.js";import"./vendor-react-eVk5PToZ.js";import"./vendor-utils-nlnd1Dju.js";function S(){const S=i(),[,P]=t(),{user:Y}=a(),{toast:D}=n(),$=S.token,[F,L]=e.useState(!1),[W,B]=e.useState("idle"),{data:K,isLoading:M,error:z}=h({queryKey:[`/api/invitations/${$}`],enabled:!!$,retry:!1}),J=j({mutationFn:async()=>{if(!Y)throw L(!0),new Error("Authentication required");B("accepting");const e=await u("POST",`/api/invitations/${$}/accept`,{});return await e.json()},onSuccess:e=>{B("success"),D({title:"Welcome to the community!",description:`You have successfully joined "${K?.community.name}"`}),x.invalidateQueries({queryKey:["/api/communities"]}),x.invalidateQueries({queryKey:[`/api/communities/${K?.community.slug}`]}),setTimeout(()=>{P(`/communities/${K?.community.slug}`)},2e3)},onError:e=>{B("error");let s="Failed to accept invitation",i=e.message;e.message.includes("already a member")?(s="Already a Member",i="You are already a member of this community."):e.message.includes("expired")?(s="Invitation Expired",i="This invitation has expired. Please request a new one."):e.message.includes("not for your email")?(s="Wrong Email Address",i="This invitation was sent to a different email address."):e.message.includes("no longer valid")&&(s="Invalid Invitation",i="This invitation is no longer valid or has been cancelled."),D({title:s,description:i,variant:"destructive"})}}),O=()=>{localStorage.setItem("redirectAfterAuth",window.location.pathname),P("/auth")},Q=!!K&&new Date(K.expiresAt)<new Date,R=Y&&K&&Y.email===K.inviteeEmail;return M?s.jsx("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:s.jsx("div",{className:"flex justify-center items-center min-h-[400px]",children:s.jsxs("div",{className:"text-center",children:[s.jsx(f,{className:"h-8 w-8 animate-spin text-primary mx-auto mb-4"}),s.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Validating Invitation"}),s.jsx("p",{className:"text-muted-foreground",children:"Please wait while we verify your invitation..."})]})})}):z||!K?s.jsx("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:s.jsxs(r,{"data-testid":"card-invalid-invitation",children:[s.jsxs(c,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-4 p-3 rounded-full bg-destructive/10",children:s.jsx(w,{className:"h-8 w-8 text-destructive"})}),s.jsx(m,{children:"Invalid Invitation"}),s.jsx(d,{children:"This invitation link is invalid or has been used already."})]}),s.jsxs(l,{className:"text-center space-y-4",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"The invitation link may have expired, been cancelled, or already used. Please contact the community administrator for a new invitation."}),s.jsx(o,{onClick:()=>P("/communities"),"data-testid":"button-browse-communities",children:"Browse Communities"})]})]})}):Q?s.jsx("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:s.jsxs(r,{"data-testid":"card-expired-invitation",children:[s.jsxs(c,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-4 p-3 rounded-full bg-amber-100",children:s.jsx(C,{className:"h-8 w-8 text-amber-600"})}),s.jsx(m,{children:"Invitation Expired"}),s.jsxs(d,{children:['This invitation to join "',K.community.name,'" has expired.']})]}),s.jsxs(l,{className:"text-center space-y-4",children:[s.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:s.jsxs("p",{className:"text-sm text-amber-800",children:["This invitation expired on ",new Date(K.expiresAt).toLocaleDateString(),". Please request a new invitation from the community administrator."]})}),s.jsx(o,{onClick:()=>P("/communities"),"data-testid":"button-browse-communities",children:"Browse Communities"})]})]})}):"accepted"===K.status?s.jsx("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:s.jsxs(r,{"data-testid":"card-already-accepted",children:[s.jsxs(c,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-4 p-3 rounded-full bg-green-100",children:s.jsx(I,{className:"h-8 w-8 text-green-600"})}),s.jsx(m,{children:"Invitation Already Accepted"}),s.jsxs(d,{children:['This invitation to join "',K.community.name,'" has already been accepted.']})]}),s.jsxs(l,{className:"text-center space-y-4",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"You are already a member of this community or this invitation has been used."}),s.jsx(o,{onClick:()=>P(`/communities/${K.community.slug}`),"data-testid":"button-visit-community",children:"Visit Community"})]})]})}):"success"===W?s.jsx("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:s.jsxs(r,{"data-testid":"card-success",children:[s.jsxs(c,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-4 p-3 rounded-full bg-green-100",children:s.jsx(I,{className:"h-8 w-8 text-green-600"})}),s.jsxs(m,{children:["Welcome to ",K.community.name,"!"]}),s.jsx(d,{children:"You have successfully joined the community."})]}),s.jsxs(l,{className:"text-center space-y-4",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Redirecting you to the community page..."}),s.jsx("div",{className:"flex justify-center",children:s.jsx(f,{className:"h-5 w-5 animate-spin"})})]})]})}):s.jsxs("div",{className:"container max-w-2xl mx-auto px-4 py-8",children:[s.jsxs(r,{"data-testid":"card-invitation",children:[s.jsxs(c,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-4 p-3 rounded-full bg-primary/10",children:s.jsx(A,{className:"h-8 w-8 text-primary"})}),s.jsx(m,{children:"You're Invited to Join a Community"}),s.jsx(d,{children:"You've been invited to join a private community on The Connection"})]}),s.jsxs(l,{className:"space-y-6",children:[s.jsxs("div",{className:"bg-muted/50 rounded-lg p-4",children:[s.jsxs("h3",{className:"font-semibold text-lg mb-2 flex items-center gap-2",children:[s.jsx(T,{className:"h-5 w-5"}),K.community.name]}),s.jsx("p",{className:"text-muted-foreground mb-3",children:K.community.description}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(T,{className:"h-4 w-4"}),s.jsxs("span",{children:[K.community.memberCount||0," members"]})]}),K.community.isPrivate&&s.jsxs("div",{className:"flex items-center gap-1 text-amber-600",children:[s.jsx(k,{className:"h-4 w-4"}),s.jsx("span",{children:"Private Community"})]})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[s.jsx(q,{className:"h-4 w-4 text-muted-foreground"}),s.jsxs("span",{children:["Invited email: ",s.jsx("strong",{children:K.inviteeEmail})]})]}),s.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[s.jsx(C,{className:"h-4 w-4 text-muted-foreground"}),s.jsxs("span",{children:["Expires: ",new Date(K.expiresAt).toLocaleDateString()]})]})]}),Y&&!R&&s.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx(E,{className:"h-5 w-5 text-amber-600 mt-0.5"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-amber-800",children:"Email Mismatch"}),s.jsxs("p",{className:"text-sm text-amber-700 mt-1",children:["This invitation was sent to ",K.inviteeEmail,", but you're signed in as ",Y.email,". You may need to sign in with the correct account or contact the community administrator."]})]})]})}),s.jsxs("div",{className:"flex flex-col gap-3 pt-4",children:[Y?s.jsx(o,{onClick:()=>{Y?J.mutate():L(!0)},disabled:J.isPending||"idle"!==W,size:"lg",className:"w-full","data-testid":"button-accept-invitation",children:"accepting"===W?s.jsxs(s.Fragment,{children:[s.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Joining Community..."]}):s.jsxs(s.Fragment,{children:[s.jsx(A,{className:"mr-2 h-4 w-4"}),"Accept Invitation"]})}):s.jsx(o,{onClick:O,size:"lg",className:"w-full","data-testid":"button-sign-in",children:"Sign In to Accept Invitation"}),s.jsx(o,{variant:"outline",onClick:()=>P("/communities"),"data-testid":"button-decline",children:"Maybe Later"})]})]})]}),s.jsx(p,{open:F,onOpenChange:L,children:s.jsxs(v,{"data-testid":"dialog-auth-required",children:[s.jsxs(g,{children:[s.jsx(y,{children:"Authentication Required"}),s.jsx(N,{children:"You need to be signed in to accept this invitation. Would you like to sign in now?"})]}),s.jsx(b,{onClick:O,"data-testid":"button-dialog-sign-in",children:"Sign In"})]})})]})}export{S as default};
